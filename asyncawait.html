<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async/Await - Usuarios, Posts y Comentarios</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #output {
            margin-top: 1em;
        }

        .user {
            margin-bottom: 2em;
        }

        .post {
            margin: 1em 0 1em 1em;
            color: blue;
        }

        .postBody {
            margin: 1em 2em;
            color: #5e0000;
        }

        .comments {
            margin-left: 2em;
            font-size: 0.95em;
            color: #333;
        }

        .comment {
            margin-bottom: 0.5em;
            padding: 0.4em;
            border-left: 3px solid #ccc;
        }

        .meta {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h1>Usuarios → Posts → Comentarios (async/await)</h1>
    <div id="output">Cargando datos...</div>

    <script>
        function callbackError(mensaje) {
            console.error("Ocurrió un error:", mensaje);
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadAll();

            async function loadAll() {
                try {
                    const resp = await fetch('https://jsonplaceholder.typicode.com/users');
                    if (!resp.ok) throw new Error(resp.statusText);
                    const users = await resp.json();
                    users.sort(function (a, b) { return a.id - b.id; });

                    // Para cada usuario obtenemos posts y para cada post sus comentarios
                    const userResults = await Promise.all(users.map(async function (user) {
                        try {
                            const r = await fetch('https://jsonplaceholder.typicode.com/users/' + user.id + '/posts');
                            if (!r.ok) throw new Error(r.statusText);
                            const posts = await r.json();

                            const postsWithComments = await Promise.all(posts.map(async function (post) {
                                try {
                                    const cr = await fetch('https://jsonplaceholder.typicode.com/posts/' + post.id + '/comments');
                                    if (!cr.ok) throw new Error(cr.statusText);
                                    const comments = await cr.json();
                                    return Object.assign({}, post, { comments: comments });
                                } catch (err) {
                                    callbackError('Error al obtener comentarios del post ' + post.id + ': ' + err.message);
                                    return Object.assign({}, post, { comments: [] });
                                }
                            }));

                            return { user: user, posts: postsWithComments };
                        } catch (err) {
                            callbackError('Error al obtener posts del usuario ' + user.id + ': ' + err.message);
                            return null;
                        }
                    }));

                    const validResults = userResults.filter(function (r) { return r !== null; });

                    if (validResults.length === 0) {
                        document.getElementById('output').innerText = 'No hay datos para mostrar.';
                        return;
                    }

                    var html = '';
                    validResults.forEach(function (result) {
                        html += '<div class="user">';
                        html += '<h2>USUARIO: ' + result.user.id + ' - ' + escapeHtml(result.user.name) + ' - <span class="meta">' + escapeHtml(result.user.email) + '</span></h2>';

                        if (!result.posts || result.posts.length === 0) {
                            html += '<div class="post">(Sin posts)</div>';
                        } else {
                            result.posts.forEach(function (post) {
                                html += '<div class="post">';
                                html += '<h3>Post #' + post.id + ': ' + escapeHtml(post.title) + '</h3>';
                                html += '<div class="postBody">' + escapeHtml(post.body) + '</div>';

                                if (!post.comments || post.comments.length === 0) {
                                    html += '<div class="comments">(Sin comentarios)</div>';
                                } else {
                                    html += '<div class="comments"><strong>Comentarios:</strong>';
                                    post.comments.forEach(function (c) {
                                        html += '<div class="comment">';
                                        html += '<div class="meta"><b>Comentario #' + c.id + ' - ' + escapeHtml(c.name) + '</b> &lt;' + escapeHtml(c.email) + '&gt;</div>';                                        
                                        html += '<div>' + escapeHtml(c.body) + '</div>';
                                        html += '</div>';
                                    });
                                    html += '</div>';
                                }

                                html += '</div>'; // .post
                            });
                        }

                        html += '</div>'; // .user
                    });

                    document.getElementById('output').innerHTML = html;
                    console.log('Todos los datos (usuarios, posts y comentarios) procesados correctamente.');

                } catch (err) {
                    callbackError('Error general: ' + err.message);
                    document.getElementById('output').innerText = 'Error al cargar datos.';
                }
            }

            // Helper mínima para escapar HTML en contenido generado
            function escapeHtml(str) {
                if (typeof str !== 'string') return '' + str;
                return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
        });
    </script>
</body>

</html>