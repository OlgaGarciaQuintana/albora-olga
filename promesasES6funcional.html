<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promesas ES6 - Estilo funcional</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #output {
            margin-top: 1em;
        }

        .user {
            margin-bottom: 2em;
        }

        .post {
            margin: 1em 0 1em 1em;
            color: blue;
        }

        .postBody {
            margin: 1em 2em;
            color: #5e0000;
        }

        .comments {
            margin-left: 2em;
            font-size: 0.95em;
            color: #333;
        }

        .comment {
            margin-bottom: 0.5em;
            padding: 0.4em;
            border-left: 3px solid #ccc;
        }

        .meta {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h1>Usuarios → Posts → Comentarios (estilo funcional ES6)</h1>
    <div id="output">Cargando datos...</div>

    <script>
        // Funciones de ayuda puras
        const callbackError = mensaje => console.error('Ocurrió un error:', mensaje);
        const escapeHtml = str => typeof str !== 'string' ? String(str) : String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

        // Render helpers (funcionales)
        const renderComment = c => [
            '<div class="comment">',
            '<div class="meta"><b>Comentario #' + c.id + ' - ' + escapeHtml(c.name) + '</b> &lt;' + escapeHtml(c.email) + '&gt;</div>',
            '<div>' + escapeHtml(c.body) + '</div>',
            '</div>'
        ].join('');

        const renderPost = post => {
            const commentsHtml = (!post.comments || post.comments.length === 0)
                ? '<div class="comments">(Sin comentarios)</div>'
                : '<div class="comments"><strong>Comentarios:</strong>' + post.comments.map(renderComment).join('') + '</div>';

            return ['<div class="post">',
                '<h3>Post #' + post.id + ': ' + escapeHtml(post.title) + '</h3>',
                '<div class="postBody">' + escapeHtml(post.body) + '</div>',
                commentsHtml,
                '</div>'
            ].join('');
        };

        const renderUser = result => {
            const header = '<h2>USUARIO: ' + result.user.id + ' - ' + escapeHtml(result.user.name) + ' - <span class="meta">' + escapeHtml(result.user.email) + '</span></h2>';
            const postsHtml = (result.posts || []).length === 0 ? '<div class="post">(Sin posts)</div>' : result.posts.map(renderPost).join('');
            return '<div class="user">' + header + postsHtml + '</div>';
        };

        document.addEventListener('DOMContentLoaded', function () {
            fetch('https://jsonplaceholder.typicode.com/users')
                .then(function (resp) {
                    if (!resp.ok) throw new Error(resp.statusText);
                    return resp.json();
                })
                .then(function (users) {
                    users.sort(function (a, b) { return a.id - b.id; });

                    var userPromises = users.map(function (user) {
                        return fetch('https://jsonplaceholder.typicode.com/users/' + user.id + '/posts')
                            .then(function (r) {
                                if (!r.ok) throw new Error(r.statusText);
                                return r.json();
                            })
                            .then(function (posts) {
                                var postPromises = posts.map(function (post) {
                                    return fetch('https://jsonplaceholder.typicode.com/posts/' + post.id + '/comments')
                                        .then(function (cr) {
                                            if (!cr.ok) throw new Error(cr.statusText);
                                            return cr.json();
                                        })
                                        .then(function (comments) {
                                            return Object.assign({}, post, { comments: comments });
                                        })
                                        .catch(function (err) {
                                            callbackError('Error al obtener comentarios del post ' + post.id + ': ' + err.message);
                                            return Object.assign({}, post, { comments: [] });
                                        });
                                });

                                return Promise.all(postPromises).then(function (postsWithComments) {
                                    return { user: user, posts: postsWithComments };
                                });
                            })
                            .catch(function (err) {
                                callbackError('Error al obtener posts del usuario ' + user.id + ': ' + err.message);
                                return null;
                            });
                    });

                    return Promise.all(userPromises);
                })
                .then(function (results) {
                    var validResults = results.filter(function (r) { return r !== null; });

                    if (validResults.length === 0) {
                        document.getElementById('output').innerText = 'No hay datos para mostrar.';
                        return;
                    }

                    var html = validResults.map(renderUser).join('');
                    document.getElementById('output').innerHTML = html;
                    console.log('Todos los datos (usuarios, posts y comentarios) procesados correctamente.');
                })
                .catch(function (err) {
                    callbackError('Error general: ' + err.message);
                    document.getElementById('output').innerText = 'Error al cargar datos.';
                });
        });
    </script>
</body>

</html>