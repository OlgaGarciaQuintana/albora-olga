<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promesas ES6 - Usuarios, Posts y Comentarios</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    #output { margin-top: 1em; }
    .user { margin-bottom: 2em; }
    .post { margin: 1em 0 1em 1em; color: blue; }
    .postBody{ margin: 1em 2em; color: #5e0000;}
    .comments { margin-left: 2em; font-size: 0.95em; color: #333; }
    .comment { margin-bottom: 0.5em; padding: 0.4em; border-left: 3px solid #ccc; }
    .meta { color: #666; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Usuarios → Posts → Comentarios (solo ES6 Promesas)</h1>
  <div id="output">Cargando datos...</div>

  <script>
    function callbackError(mensaje) {
      console.error("Ocurrió un error:", mensaje);
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetch('https://jsonplaceholder.typicode.com/users')
        .then(function (resp) {
          if (!resp.ok) throw new Error(resp.statusText);
          return resp.json();
        })
        .then(function (users) {
          users.sort(function (a, b) { return a.id - b.id; });

          // Por cada usuario pedimos sus posts y para cada post sus comentarios
          var userPromises = users.map(function (user) {
            return fetch('https://jsonplaceholder.typicode.com/users/' + user.id + '/posts')
              .then(function (r) {
                if (!r.ok) throw new Error(r.statusText);
                return r.json();
              })
              .then(function (posts) {
                // Para cada post pedimos sus comentarios
                var postWithCommentsPromises = posts.map(function (post) {
                  return fetch('https://jsonplaceholder.typicode.com/posts/' + post.id + '/comments')
                    .then(function (cr) {
                      if (!cr.ok) throw new Error(cr.statusText);
                      return cr.json();
                    })
                    .then(function (comments) {
                      // Devolvemos el post con su array de comentarios
                      return Object.assign({}, post, { comments: comments });
                    })
                    .catch(function (err) {
                      callbackError('Error al obtener comentarios del post ' + post.id + ': ' + err.message);
                      // Devolver post con comentarios vacíos para no romper el Promise.all
                      return Object.assign({}, post, { comments: [] });
                    });
                });

                // Esperamos todos los comentarios para los posts de este usuario
                return Promise.all(postWithCommentsPromises)
                  .then(function (postsWithComments) {
                    return { user: user, posts: postsWithComments };
                  });

              })
              .catch(function (err) {
                callbackError('Error al obtener posts del usuario ' + user.id + ': ' + err.message);
                return null;
              });
          });

          return Promise.all(userPromises);
        })
        .then(function (results) {
          var validResults = results.filter(function (r) { return r !== null; });

          if (validResults.length === 0) {
            document.getElementById('output').innerText = 'No hay datos para mostrar.';
            return;
          }

          var html = '';
          validResults.forEach(function (result) {
            html += '<div class="user">';
            html += '<h2>USUARIO: ' + result.user.id + ' - ' + escapeHtml(result.user.name) + ' - <span class="meta">' + escapeHtml(result.user.email) + '</span></h2>';

            if (!result.posts || result.posts.length === 0) {
              html += '<div class="post">(Sin posts)</div>';
            } else {
              result.posts.forEach(function (post) {
                html += '<div class="post">';
                html += '<h3>Post #' + post.id + ': ' + escapeHtml(post.title) + '</h3>';                
                html += '<div class="postBody">' + escapeHtml(post.body) + '</div>';

                if (!post.comments || post.comments.length === 0) {
                  html += '<div class="comments">(Sin comentarios)</div>';
                } else {
                  html += '<div class="comments"><strong>Comentarios:</strong>';
                  post.comments.forEach(function (c) {
                    html += '<div class="comment">';
                    html += '<div class="meta"><b>Comentario #' + c.id + ' - ' + escapeHtml(c.name) + '</b> &lt;' + escapeHtml(c.email) + '&gt;</div>';
                    html += '<div>' + escapeHtml(c.body) + '</div>';
                    html += '</div>';
                  });
                  html += '</div>';
                }

                html += '</div>'; // .post
              });
            }

            html += '</div>'; // .user
          });

          document.getElementById('output').innerHTML = html;
          console.log('Todos los datos (usuarios, posts y comentarios) procesados correctamente.');
        })
        .catch(function (err) {
          callbackError('Error general: ' + err.message);
          document.getElementById('output').innerText = 'Error al cargar datos.';
        });

      console.log('Petición AJAX enviada... Yo acabo.');

      // Helper mínima para escapar HTML en contenido generado
      function escapeHtml(str) {
        if (typeof str !== 'string') return '' + str;
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
      }
    });
  </script>
</body>
</html>